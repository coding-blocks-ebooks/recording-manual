sudo: required
language: node_js
node_js: 8
cache:
  directories:
  - node_modules
addons:
  apt:
    update: true
    packages:
    - calibre
    - xvfb
before_install:
- npm install -g gitbook-cli
- echo '#!/bin/bash' >> $HOME/bin/ebook-convert
- echo 'xvfb-run /usr/bin/ebook-convert "$@"' >> $HOME/bin/ebook-convert
- chmod a+x $HOME/bin/ebook-convert
install:
- gitbook install
script:
- gitbook build
- gitbook pdf
- gitbook epub
- gitbook mobi
- cp -fv ./book.pdf ./_book/book.pdf
- cp -fv ./book.epub ./_book/book.epub
- cp -fv ./book.mobi ./_book/book.epub
deploy:
- provider: pages
  skip-cleanup: true
  github-token: "$GITHUB_TOKEN"
  keep-history: true
  local-dir: "./_book"
  on:
    branch: master
- provider: releases
  skip-cleanup: true
  api_key: "$GITHUB_TOKEN"
  file:
  - _book/book.pdf
  - _book/book.epub
  - _book/book.mobi
  on:
    tags: true